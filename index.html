<!doctype html>
<html lang="pt-br" class="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Login — SAE</title>

  <!-- PWA e Meta Tags -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#400c88">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="img/KBT_logo2.png" />

  <!-- Fontes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <!-- CSS -->
  <link rel="stylesheet" href="css/base.css" />

  <style>
    /* Estilo para o banner PWA deslizar */
    #pwa-install-banner { 
      visibility: hidden; 
      transition: bottom 0.5s ease-in-out;
    }
    #pwa-install-banner.show { 
      visibility: visible !important; 
      bottom: 0 !important;
    }

    /* Estilo do Checkbox Lembrar-me */
    .lembrar-box {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 15px;
      cursor: pointer;
    }
    .lembrar-box input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primario);
      cursor: pointer;
    }
    .lembrar-box label {
      font-size: 14px;
      color: var(--texto-fraco);
      font-weight: 500;
      margin: 0;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>

<body class="centralizado">

  <main id="tela-login" class="card">
    <div class="card-header">
      <div class="logo-box">
        <img src="img/KBT_logo2.png" alt="Logo KBT" class="logo2-icon">
      </div>
      <p class="subtitle" style="margin-top: 10px; font-family: Inter; font-weight: 600; color: var(--texto-fraco);">
        Sistema de Aulas Experimentais
      </p>
    </div>

    <form id="formLogin" autocomplete="on">
      <label for="email">E-mail</label>
      <input id="email" name="email" type="email" required placeholder="seuemail@exemplo.com" />
      
      <label for="senha">Senha</label>
      <input id="senha" name="senha" type="password" required placeholder="••••••••" />
      
      <!-- Checkbox Mantenha-me conectado -->
      <div class="lembrar-box">
        <input type="checkbox" id="lembrar" name="lembrar" checked>
        <label for="lembrar">Mantenha-me conectado</label>
      </div>
      
      <button id="btnEntrar" type="submit" style="margin-top: 14px; width: 100%;">Entrar</button>

      <p id="msgCarregando" hidden style="margin-top:10px; text-align: center;">Entrando…</p>
      <p id="msgErro" role="alert" hidden style="margin-top:10px; color:#b91c1c; font-weight:700; text-align: center;"></p>
    </form>

    <div style="margin-top: 25px; text-align: center; border-top: 1px solid var(--borda); padding-top: 20px;">
      <p style="font-size: 14px; color: var(--texto-fraco);">
        É professor e não tem conta? <br>
        <a href="paginas/cadastro.html" style="color: var(--primario); text-decoration: none; font-weight: 800;">Solicite seu cadastro aqui</a>
      </p>
    </div>
  </main>

  <!-- Banner PWA Estilo Globo -->
  <div id="pwa-install-banner" class="pwa-banner">
    <div class="pwa-content">
      <div class="pwa-header">
        <img src="img/KBT_logo2.png" alt="Logo KBT" class="pwa-logo">
        <div class="pwa-text">
          <strong>Instalar SAE Kabuto?</strong>
          <p>Acesse como um app para uma melhor experiência.</p>
        </div>
      </div>
      <div class="pwa-actions">
        <button id="btn-pwa-cancel" class="btn-pwa-secondary">Agora não</button>
        <button id="btn-pwa-install" class="btn-pwa-primary">Instalar</button>
      </div>
    </div>
  </div>

  <!-- Scripts Principais -->
  <script type="module" src="js/autenticacao.js"></script>
  <script type="module" src="js/pwa-install.js"></script>
  
  <!-- Ícones -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>lucide.createIcons();</script>

  <!-- Lógica de Sessão e Service Worker -->
  <script type="module">
    import { supabase } from './js/supabaseCliente.js';

    document.addEventListener("DOMContentLoaded", async () => {
        // 1. Verifica sessão ativa no Supabase
        const { data: { session } } = await supabase.auth.getSession();

        if (session) {
            // Se logado, busca o perfil para redirecionar ao local correto
            const { data: perfil } = await supabase
                .from('profiles')
                .select('role')
                .eq('id', session.user.id)
                .single();

            if (perfil?.role === 'admin') {
                window.location.href = "paginas/admin.html";
            } else {
                window.location.href = "paginas/professor.html";
            }
        }

        // 2. Registro do Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('✅ PWA: Service Worker Ativo'))
                .catch(err => console.error('❌ PWA: Erro no SW', err));
        }
    });
  </script>

</body>
</html>